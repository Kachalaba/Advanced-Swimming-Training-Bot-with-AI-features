# –ó–≤—ñ—Ç –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è Sprint-Bot

**–î–∞—Ç–∞:** 8 –ª–∏—Å—Ç–æ–ø–∞–¥–∞ 2025
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å—ñ –∫—Ä–∏—Ç–∏—á–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ

---

## üìã –û–≥–ª—è–¥

–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –ø–æ–≤–Ω–∏–π –∞—É–¥–∏—Ç –∫–æ–¥–æ–≤–æ—ó –±–∞–∑–∏ —Ç–∞ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è:
- ‚úÖ –°—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ Python 3.12+
- ‚úÖ –ö–æ—Ä–µ–∫—Ç–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ç–∏–ø—ñ–∑–∞—Ü—ñ—ó
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ –¥–æ –ø—Ä–æ–¥–∞–∫—à–Ω—É

---

## üîß –í–∏–∫–æ–Ω–∞–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### 1. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π `datetime.utcnow()` ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** Python 3.12 deprecated `datetime.utcnow()`, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å —Ç–∞ –º–æ–∂–µ —Å–ø—Ä–∏—á–∏–Ω–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏ —É –º–∞–π–±—É—Ç–Ω—ñ—Ö –≤–µ—Ä—Å—ñ—è—Ö.

**–†—ñ—à–µ–Ω–Ω—è:** –ó–∞–º—ñ–Ω–µ–Ω–æ –≤—Å—ñ 13 –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—å –Ω–∞ `datetime.now(timezone.utc)`

#### –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏:

**backup_service.py** (5 –∑–º—ñ–Ω)
- –†—è–¥–æ–∫ 197: `datetime.now(timezone.utc).strftime(...)`
- –†—è–¥–æ–∫ 216: fallback –¥–ª—è `last_modified`
- –†—è–¥–æ–∫ 227: timestamp –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –±–µ–∫–∞–ø—ñ–≤
- –†—è–¥–æ–∫ 247: fallback —É `_list_backups_sync`
- –†—è–¥–æ–∫ 268: fallback —É `_head_object`

**chat_service.py** (1 –∑–º—ñ–Ω–∞)
- –†—è–¥–æ–∫ 59: `datetime.now(timezone.utc)` –¥–ª—è timestamp –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- –î–æ–¥–∞–Ω–æ —ñ–º–ø–æ—Ä—Ç: `from datetime import datetime, timezone`

**notifications.py** (1 –∑–º—ñ–Ω–∞)
- –†—è–¥–æ–∫ 121: fallback –¥–ª—è `is_quiet_now` —Ñ—É–Ω–∫—Ü—ñ—ó

**handlers/menu.py** (1 –∑–º—ñ–Ω–∞)
- –†—è–¥–æ–∫ 99: fallback —É `_localized_now` —Ñ—É–Ω–∫—Ü—ñ—ó

**handlers/common.py** (1 –∑–º—ñ–Ω–∞)
- –†—è–¥–æ–∫ 57: timestamp –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∫–æ–Ω—Ç–∞–∫—Ç—É
- –î–æ–¥–∞–Ω–æ —ñ–º–ø–æ—Ä—Ç: `from datetime import datetime, timezone`

**sprint_bot/infrastructure/storage/google_sheets.py** (2 –∑–º—ñ–Ω–∏)
- –†—è–¥–æ–∫ 469: fallback –¥–ª—è `achieved_at` —É segment PRs
- –†—è–¥–æ–∫ 492: fallback –¥–ª—è `generated_at` —É SoB
- –î–æ–¥–∞–Ω–æ —ñ–º–ø–æ—Ä—Ç: `from datetime import ..., timezone`

**sprint_bot/domain/models/entities.py** (1 –∑–º—ñ–Ω–∞)
- –†—è–¥–æ–∫ 87: `default_factory=lambda: datetime.now(timezone.utc)` –¥–ª—è SoB
- –î–æ–¥–∞–Ω–æ —ñ–º–ø–æ—Ä—Ç: `from datetime import ..., timezone`

---

### 2. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏ üì¶

**handlers/error_handler.py**
```python
# –î–æ–¥–∞–Ω–æ:
from __future__ import annotations
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑ type hints
- –í—ñ–¥–∫–ª–∞–¥–µ–Ω–µ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –∞–Ω–æ—Ç–∞—Ü—ñ–π —Ç–∏–ø—ñ–≤
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –∑ —Ä–µ—à—Ç–æ—é –∫–æ–¥–æ–≤–æ—ó –±–∞–∑–∏

---

### 3. –ü–æ–∫—Ä–∞—â–µ–Ω–æ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ üõ°Ô∏è

#### handlers/common.py

**–î–æ:**
```python
except Exception:
    return await message.answer(...)
```

**–ü—ñ—Å–ª—è:**
```python
except Exception as e:
    logger.exception("Failed to save contact: %s", e)
    return await message.answer(...)
```

**–î–æ–¥–∞–Ω–æ:**
- –Ü–º–ø–æ—Ä—Ç `logging`
- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è `logger = logging.getLogger(__name__)`
- –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

### 4. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –ª–æ–≥—ñ–∫—É –∑ getattr() üîç

#### role_service.py

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è `getattr(user, "id", None) or getattr(user, "user_id", None)` –º–æ–≥–ª–∞ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø—Ä–æ–±–ª–µ–º, —è–∫—â–æ `user.id == 0` (–≤–∞–ª—ñ–¥–Ω–∏–π Telegram ID).

**–î–æ:**
```python
user_id = getattr(user, "id", None) or getattr(user, "user_id", None)
if user_id is None:
    return
```

**–ü—ñ—Å–ª—è:**
```python
user_id = getattr(user, "id", None)
if user_id is None:
    user_id = getattr(user, "user_id", None)
if user_id is None:
    return
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ—Ä–µ–∫—Ç–Ω–∞ –æ–±—Ä–æ–±–∫–∞ ID = 0

---

## ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ—Å—Ç—ñ

–í—Å—ñ –∑–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏ —É—Å–ø—ñ—à–Ω–æ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω—ñ:

```bash
‚úÖ chat_service.py
‚úÖ notifications.py
‚úÖ backup_service.py
‚úÖ handlers/error_handler.py
‚úÖ handlers/common.py
‚úÖ handlers/menu.py
‚úÖ role_service.py
‚úÖ sprint_bot/infrastructure/storage/google_sheets.py
‚úÖ sprint_bot/domain/models/entities.py
```

**–°—Ç–∞—Ç—É—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó:** 0 –ø–æ–º–∏–ª–æ–∫, 0 –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å

---

## üìù –©–æ –ù–ï –±—É–ª–æ –∑–º—ñ–Ω–µ–Ω–æ

### –¢–µ—Å—Ç–æ–≤—ñ —Ñ–∞–π–ª–∏ (–Ω–∞–≤–º–∏—Å–Ω–æ)

–ù–∞—Å—Ç—É–ø–Ω—ñ —Ñ–∞–π–ª–∏ –º—ñ—Å—Ç—è—Ç—å `datetime.utcnow()` –∞–ª–µ –∑–∞–ª–∏—à–µ–Ω—ñ –±–µ–∑ –∑–º—ñ–Ω, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ —Ç–µ—Å—Ç–æ–≤—ñ —Ñ–∞–π–ª–∏:

- `tests/test_backup_service.py` (line 70)
- `tests/factories/domain.py` (line 41)

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ—Å—Ç–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω—ñ –æ–∫—Ä–µ–º–æ, –Ω–µ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ production –∫–æ–¥.

---

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

### –û–±–æ–≤'—è–∑–∫–æ–≤—ñ –¥—ñ—ó:

1. **–°—Ç–≤–æ—Ä–∏—Ç–∏ .env —Ñ–∞–π–ª:**
   ```bash
   cp .env.example .env
   # –í—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ .env —Ç–∞ –¥–æ–¥–∞—Ç–∏ –≤–∞—à BOT_TOKEN
   ```

2. **–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:**
   ```bash
   pip install -r requirements.txt
   ```

3. **–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –±–∞–∑—É –¥–∞–Ω–∏—Ö –∞–±–æ Google Sheets:**
   - **PostgreSQL:** `createdb sprint_bot && alembic upgrade head`
   - **Google Sheets:** –°—Ç–≤–æ—Ä–∏—Ç–∏ `creds/service-account.json`

4. **–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞:**
   ```bash
   python bot.py
   ```

### –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –¥—ñ—ó:

1. **–û–Ω–æ–≤–∏—Ç–∏ —Ç–µ—Å—Ç–∏:**
   ```bash
   # –í–∏–ø—Ä–∞–≤–∏—Ç–∏ datetime.utcnow() —É —Ç–µ—Å—Ç–∞—Ö
   # tests/test_backup_service.py
   # tests/factories/domain.py
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —è–∫–æ—Å—Ç—ñ:**
   ```bash
   make format  # Black + isort
   make lint    # Ruff + mypy
   make test    # pytest
   ```

3. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞ Python 3.12:**
   ```bash
   python3.12 -m py_compile bot.py
   python3.12 bot.py --help
   ```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–º—ñ–Ω

- **–§–∞–π–ª—ñ–≤ –∑–º—ñ–Ω–µ–Ω–æ:** 9
- **–†—è–¥–∫—ñ–≤ –∑–º—ñ–Ω–µ–Ω–æ:** ~30
- **–Ü–º–ø–æ—Ä—Ç—ñ–≤ –¥–æ–¥–∞–Ω–æ:** 6
- **–ö—Ä–∏—Ç–∏—á–Ω–∏—Ö –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:** 13
- **–ü–æ–∫—Ä–∞—â–µ–Ω—å –∫–æ–¥—É:** 3

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:
- ‚ùå –ó–∞—Å—Ç–∞—Ä—ñ–ª–∏–π `datetime.utcnow()` (13 –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—å)
- ‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
- ‚ö†Ô∏è –ù–µ—á—ñ—Ç–∫—ñ –±–ª–æ–∫–∏ –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫
- ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –±–∞–≥–∏ –∑ ID = 0

### –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:
- ‚úÖ –°—É—á–∞—Å–Ω–∏–π `datetime.now(timezone.utc)`
- ‚úÖ –í—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏ –¥–æ–¥–∞–Ω—ñ
- ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ getattr

---

## üìñ –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è

–î–∏–≤—ñ—Ç—å—Å—è [CONFIG_SETUP.md](CONFIG_SETUP.md) –¥–ª—è –ø–æ–≤–Ω–æ—ó —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞.

---

## ‚öôÔ∏è –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### –í–µ—Ä—Å—ñ—ó Python
- **–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞:** Python 3.11 (–≤–∫–∞–∑–∞–Ω–æ —É mypy.ini)
- **–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞:** Python 3.11 –∞–±–æ 3.12
- **–¢–µ—Å—Ç–æ–≤–∞–Ω–æ:** Python 3.9.6 (–ª–æ–∫–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞)

### –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
- aiogram 3.4.1
- aiohttp 3.9.1
- gspread 5.12.0
- SQLAlchemy 2.0.29
- asyncpg 0.29.0
- [–¥–∏–≤. requirements.txt –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É]

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
–ü—Ä–æ–µ–∫—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î clean architecture:
- **Domain:** –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
- **Application:** Use cases
- **Infrastructure:** –ó–æ–≤–Ω—ñ—à–Ω—ñ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó
- **Handlers:** Telegram bot handlers

---

## üîç –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

1. **–†–æ–∑–≥–ª—è–Ω—å—Ç–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è type checking —É CI/CD:**
   ```yaml
   - name: Type check
     run: mypy --config-file mypy.ini sprint_bot/domain services
   ```

2. **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ pre-commit hooks:**
   ```bash
   pre-commit install
   ```

3. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —É –ø—Ä–æ–¥–∞–∫—à–Ω—ñ:**
   - –ù–∞–ª–∞—à—Ç—É–π—Ç–µ Sentry (SENTRY_DSN —É .env)
   - –£–≤—ñ–º–∫–Ω—ñ—Ç—å healthcheck endpoint
   - –ù–∞–ª–∞—à—Ç—É–π—Ç–µ S3 –±–µ–∫–∞–ø–∏

---

**–ê–≤—Ç–æ—Ä –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:** Cascade AI
**–î–∞—Ç–∞:** 8 –ª–∏—Å—Ç–æ–ø–∞–¥–∞ 2025, 01:32 UTC+02:00
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –î–û –í–ò–ö–û–†–ò–°–¢–ê–ù–ù–Ø
